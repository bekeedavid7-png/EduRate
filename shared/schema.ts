import { pgTable, text, serial, integer, boolean, timestamp } from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

// === TABLE DEFINITIONS ===

export const courses = pgTable("courses", {
  id: serial("id").primaryKey(),
  department: text("department").notNull(),
  code: text("code").notNull(),
  name: text("name").notNull(),
});

export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  username: text("username").notNull().unique(),
  password: text("password").notNull(),
  role: text("role", { enum: ['student', 'lecturer'] }).notNull(),
  name: text("name").notNull(),
  department: text("department"),
  courseId: integer("course_id").references(() => courses.id),
});

export const evaluations = pgTable("evaluations", {
  id: serial("id").primaryKey(),
  studentId: integer("student_id").notNull().references(() => users.id),
  lecturerId: integer("lecturer_id").notNull().references(() => users.id),
  courseId: integer("course_id").notNull().references(() => courses.id),
  overallRating: integer("overall_rating").notNull(),
  clarityRating: integer("clarity_rating").notNull(),
  engagementRating: integer("engagement_rating").notNull(),
  comments: text("comments"),
  createdAt: timestamp("created_at").defaultNow(),
});

// === RELATIONS ===
export const usersRelations = relations(users, ({ one, many }) => ({
  course: one(courses, {
    fields: [users.courseId],
    references: [courses.id],
  }),
  givenEvaluations: many(evaluations, { relationName: 'student' }),
  receivedEvaluations: many(evaluations, { relationName: 'lecturer' }),
}));

export const coursesRelations = relations(courses, ({ many }) => ({
  lecturers: many(users),
  evaluations: many(evaluations),
}));

export const evaluationsRelations = relations(evaluations, ({ one }) => ({
  student: one(users, {
    fields: [evaluations.studentId],
    references: [users.id],
    relationName: 'student'
  }),
  lecturer: one(users, {
    fields: [evaluations.lecturerId],
    references: [users.id],
    relationName: 'lecturer'
  }),
  course: one(courses, {
    fields: [evaluations.courseId],
    references: [courses.id],
  }),
}));

// === BASE SCHEMAS ===
export const insertCourseSchema = createInsertSchema(courses).omit({ id: true });
export const insertUserSchema = createInsertSchema(users).omit({ id: true });
export const insertEvaluationSchema = createInsertSchema(evaluations).omit({ id: true, createdAt: true, studentId: true }); // studentId injected by auth

// === EXPLICIT API CONTRACT TYPES ===

export type Course = typeof courses.$inferSelect;
export type User = typeof users.$inferSelect;
export type Evaluation = typeof evaluations.$inferSelect;

export type UserWithoutPassword = Omit<User, 'password'>;

// Requests
export const loginSchema = z.object({
  username: z.string(),
  password: z.string(),
});
export type LoginRequest = z.infer<typeof loginSchema>;

export const registerSchema = insertUserSchema.extend({
  courseId: z.coerce.number().optional(),
});
export type RegisterRequest = z.infer<typeof registerSchema>;

export type CreateEvaluationRequest = z.infer<typeof insertEvaluationSchema>;

export interface EvaluationSummary {
  averageOverall: number;
  averageClarity: number;
  averageEngagement: number;
  ratingDistribution: {
    excellent: number; // 5
    good: number;      // 4
    average: number;   // 3
    poor: number;      // 1-2
  };
  totalEvaluations: number;
}
